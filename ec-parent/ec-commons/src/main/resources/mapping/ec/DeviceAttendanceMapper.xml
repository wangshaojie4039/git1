<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.imexue.ec.common.mapper.ec.DeviceAttendanceMapper" >
	
	<select id="pageList" resultType="cn.imexue.ec.common.model.DeviceAttendance">
		SELECT
			a.id,
			a.`name`,
			a.model,
			a.image_url AS imageUrl,
			IF(a.is_default_device_no=1,'',a.device_no) AS deviceNo,
			a.device_secret AS deviceSecret,
			a.product_type as productType,
			a.school_id AS schoolId,
			s.`name` AS schoolName,
			a.order_no AS orderNo,
			a.confirm_time AS confirmTime,
			p.`name` AS productName,
			a.is_active AS isActive,
			a.version_no
		FROM t_device_attendance a
		LEFT JOIN t_school s ON a.school_id = s.id
		LEFT JOIN t_customer_product p ON a.product_id = p.id
		LEFT JOIN t_province pr on s.province_id = pr.id
		LEFT JOIN t_city ci on s.city_id = ci.id
		LEFT JOIN t_district di on s.district_id = di.id
		WHERE 1=1 and
		a.school_id = #{schoolId}
		<if test="provinceId != null">
		AND pr.id = #{provinceId}
		</if>
		<if test="cityId != null">
		AND ci.id = #{cityId}
		</if>
		<if test="districtId != null">
		AND di.id = #{districtId}
		</if>
		<if test="customerId != null">
		AND a.customer_id = #{customerId}
		</if>
		<if test="schoolName != null">
			AND s.name like concat('%',#{schoolName},'%')
		</if>
		<if test="isActive != null">
			AND a.is_active = #{isActive}
		</if>
		<if test="productType != null">
			AND a.product_type = #{productType}
		</if>
		<if test="deviceNo != null">
			AND a.device_no = #{deviceNo}
			AND a.is_default_device_no=0
		</if>
		<if test="judge != null">
			ORDER BY ${orderBy} ${orderType}
		</if>
		<if test="judge == null">
			ORDER BY a.${orderBy} ${orderType}
		</if>
	</select>
	
    <select id="selectBydeviceNo"  resultType="cn.imexue.ec.common.model.DeviceAttendance">
		select
			<include refid="Base_Column_List" />
		from t_device_attendance t
		where t.device_no=#{deviceNo}
	</select>
  <sql id="Base_Column_List" >
    id, customer_id, product_id, school_id, school_name, device_no, is_default_device_no, 
    device_secret, name, model, image_url, order_no, confirm_time, is_active, install_time, 
    create_time, creator_role, creator_id, update_time, updater_role, updater_id ,version_no
  </sql>

  <select id="getById" resultType="cn.imexue.ec.common.model.DeviceAttendance">
    select 
    <include refid="Base_Column_List" />
    from t_device_attendance
    where id = #{id,jdbcType=BIGINT}
  </select>
  <!-- 校车考勤机编号-名称列表 -->
  <select id="findBusDeviceAttendance" resultType="cn.imexue.ec.common.model.common.KeyValuePair">
    select 
     device_no as 'key',name as 'value'
    from t_device_attendance
    where school_id = #{schoolId,jdbcType=BIGINT}
    and is_default_device_no=0
    and is_active=1
    and device_no not in(select  IFNULL(attendance_device_no,"0")  from t_xc_bus where is_delete=0 and school_id = #{schoolId,jdbcType=BIGINT}  )
     <if test="productType != null" >
      and  product_type = #{productType,jdbcType=VARCHAR}
      </if>
   </select>
  
  <select id="getByIdOrDeviceNo" resultType="cn.imexue.ec.common.model.DeviceAttendance">
    select 
    <include refid="Base_Column_List" />
    from t_device_attendance
    where 1=1
    <if test="id != null" >
    and id = #{id,jdbcType=BIGINT} 
    </if>
    <if test="deviceNo != null" >
    and device_no = #{deviceNo,jdbcType=VARCHAR} 
    </if>
  </select>
  
  
  
  
  
  
  <insert id="insert">
    insert into t_device_attendance
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="customerId != null" >
        customer_id,
      </if>
      <if test="productId != null" >
        product_id,
      </if>
      <if test="schoolId != null" >
        school_id,
      </if>
      <if test="schoolName != null" >
        school_name,
      </if>
      <if test="deviceNo != null" >
        device_no,
      </if>
      <if test="isDefaultDeviceNo != null" >
        is_default_device_no,
      </if>
      <if test="deviceSecret != null" >
        device_secret,
      </if>
      <if test="name != null" >
        name,
      </if>
      <if test="model != null" >
        model,
      </if>
      <if test="imageUrl != null" >
        image_url,
      </if>
      <if test="orderNo != null" >
        order_no,
      </if>
      <if test="confirmTime != null" >
        confirm_time,
      </if>
      <if test="isActive != null" >
        is_active,
      </if>
      <if test="installTime != null" >
        install_time,
      </if>
      <if test="createTime != null" >
        create_time,
      </if>
      <if test="creatorRole != null" >
        creator_role,
      </if>
      <if test="creatorId != null" >
        creator_id,
      </if>
      <if test="updateTime != null" >
        update_time,
      </if>
      <if test="updaterRole != null" >
        updater_role,
      </if>
      <if test="updaterId != null" >
        updater_id,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=BIGINT},
      </if>
      <if test="customerId != null" >
        #{customerId,jdbcType=BIGINT},
      </if>
      <if test="productId != null" >
        #{productId,jdbcType=BIGINT},
      </if>
      <if test="schoolId != null" >
        #{schoolId,jdbcType=BIGINT},
      </if>
      <if test="schoolName != null" >
        #{schoolName,jdbcType=VARCHAR},
      </if>
      <if test="deviceNo != null" >
        #{deviceNo,jdbcType=VARCHAR},
      </if>
      <if test="isDefaultDeviceNo != null" >
        #{isDefaultDeviceNo,jdbcType=TINYINT},
      </if>
      <if test="deviceSecret != null" >
        #{deviceSecret,jdbcType=VARCHAR},
      </if>
      <if test="name != null" >
        #{name,jdbcType=VARCHAR},
      </if>
      <if test="model != null" >
        #{model,jdbcType=VARCHAR},
      </if>
      <if test="imageUrl != null" >
        #{imageUrl,jdbcType=VARCHAR},
      </if>
      <if test="orderNo != null" >
        #{orderNo,jdbcType=VARCHAR},
      </if>
      <if test="confirmTime != null" >
        #{confirmTime,jdbcType=TIMESTAMP},
      </if>
      <if test="isActive != null" >
        #{isActive,jdbcType=TINYINT},
      </if>
      <if test="installTime != null" >
        #{installTime,jdbcType=TIMESTAMP},
      </if>
      <if test="createTime != null" >
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="creatorRole != null" >
        #{creatorRole,jdbcType=VARCHAR},
      </if>
      <if test="creatorId != null" >
        #{creatorId,jdbcType=BIGINT},
      </if>
      <if test="updateTime != null" >
        #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updaterRole != null" >
        #{updaterRole,jdbcType=VARCHAR},
      </if>
      <if test="updaterId != null" >
        #{updaterId,jdbcType=BIGINT},
      </if>
    </trim>
  </insert>
  <update id="update">
    update t_device_attendance
    <set >
      <if test="customerId != null" >
        customer_id = #{customerId,jdbcType=BIGINT},
      </if>
      <if test="productId != null" >
        product_id = #{productId,jdbcType=BIGINT},
      </if>
      <if test="schoolId != null" >
        school_id = #{schoolId,jdbcType=BIGINT},
      </if>
      <if test="schoolName != null" >
        school_name = #{schoolName,jdbcType=VARCHAR},
      </if>
      <if test="deviceNo != null" >
        device_no = #{deviceNo,jdbcType=VARCHAR},
      </if>
      <if test="isDefaultDeviceNo != null" >
        is_default_device_no = #{isDefaultDeviceNo,jdbcType=TINYINT},
      </if>
      <if test="deviceSecret != null" >
        device_secret = #{deviceSecret,jdbcType=VARCHAR},
      </if>
      <if test="name != null" >
        name = #{name,jdbcType=VARCHAR},
      </if>
      <if test="model != null" >
        model = #{model,jdbcType=VARCHAR},
      </if>
      <if test="imageUrl != null" >
        image_url = #{imageUrl,jdbcType=VARCHAR},
      </if>
      <if test="orderNo != null" >
        order_no = #{orderNo,jdbcType=VARCHAR},
      </if>
      <if test="confirmTime != null" >
        confirm_time = #{confirmTime,jdbcType=TIMESTAMP},
      </if>
      <if test="isActive != null" >
        is_active = #{isActive,jdbcType=TINYINT},
      </if>
      <if test="installTime != null" >
        install_time = #{installTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updateTime != null" >
        update_time = #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updaterRole != null" >
        updater_role = #{updaterRole,jdbcType=VARCHAR},
      </if>
      <if test="updaterId != null" >
        updater_id = #{updaterId,jdbcType=BIGINT},
      </if>
        version_no = version_no+1
    </set>
    where id = #{id,jdbcType=BIGINT} AND version_no = #{versionNo}
  </update>
</mapper>
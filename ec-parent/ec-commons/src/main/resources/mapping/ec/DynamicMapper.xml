<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.imexue.ec.common.mapper.ec.DynamicMapper" >


	<select id="pageList"  resultType="cn.imexue.ec.common.model.vo.DynamicVO">
		select DISTINCT d.id,d.dynamic_type as dynamicType,d.content,(CASE WHEN d.user_role='T' THEN CONCAT(t.name,' ',t.mobile)
		ELSE CONCAT(p.name,' ',p.mobile) END) AS userInfo,(select count(1) from t_dynamic_comment dc where dc.dynamic_id=d.id  ) as commentCount ,
		(select count(1) from t_dynamic_like dl where dl.dynamic_id=d.id  ) as likeCount ,d.create_time,d.user_role as userRole,
		d.user_id as userId
		from t_dynamic d  left join t_teacher t
		on d.user_role='T' and d.user_id=t.id left join t_parent p
		on d.user_role='P' and d.user_id=p.id left join t_dynamic_class_map dcm 
		on d.id=dcm.dynamic_id 
		where  d.is_delete=0
		and d.school_id=#{schoolId,jdbcType=BIGINT} 
		<if test="teacherId!=null and teacherId>0">
		and (
			(d.user_id=#{teacherId,jdbcType=BIGINT} AND d.user_role = 'T')
			or (
			d.user_id in(
				SELECT tsm.teacher_id from t_school s left join t_teacher_school_map tsm
				on s.id=tsm.id where  tsm.role='D' and   school_id =#{schoolId,jdbcType=BIGINT} 
			)
			 AND d.user_role = 'T'
			)
			 or dcm.class_id in(
			 	select class_id from t_class_teacher_map ctp left join t_class c
			 	on ctp.class_id=c.id 
  				where c.is_delete=0 and c.is_graduate=0 and ctp.teacher_id=#{teacherId} and ctp.school_id=#{schoolId}
			 )
		)
		</if>
		<if test="classId!=null and classId>0">
			and dcm.class_id=#{classId,jdbcType=BIGINT}
		</if>
		<if test="userInfo!=null and userInfo!=''">
			 and (t.name like concat('%',#{userInfo,jdbcType=VARCHAR},'%')
			     or t.mobile like concat('%',#{userInfo,jdbcType=VARCHAR},'%')
			     or p.name like concat('%',#{userInfo,jdbcType=VARCHAR},'%')
			     or p.mobile like concat('%',#{userInfo,jdbcType=VARCHAR},'%')
			)
		</if>
		<if test="content!=null  and content!=''">
			and d.content like concat('%',#{content,jdbcType=VARCHAR},'%')
		</if>
		<if test="startTime!=null">
			<![CDATA[  and d.create_time >= #{startTime,jdbcType=TIMESTAMP}]]>
		</if>
		<if test="endTime!=null">
			<![CDATA[  and d.create_time <=  #{endTime,jdbcType=TIMESTAMP}]]> 
		</if>
		ORDER BY ${orderBy} ${orderType}
	</select>



  <select id="selectById" parameterType="java.lang.Long" resultType="cn.imexue.ec.common.model.vo.DynamicVO">
    select 
    <include refid="Base_Column_List" />
    from t_dynamic
    where is_delete=0 and id = #{id,jdbcType=BIGINT}
  </select>


  <delete id="deleteById"  parameterType="java.lang.Long">
	  delete from t_dynamic
	  where id = #{id,jdbcType=BIGINT}
  </delete>


  <update id="updateByIdSelective" parameterType="cn.imexue.ec.common.model.Dynamic" >
    update t_dynamic
    <set >
      <if test="uuid != null" >
        uuid = #{uuid,jdbcType=VARCHAR},
      </if>
      <if test="schoolId != null" >
        school_id = #{schoolId,jdbcType=BIGINT},
      </if>
      <if test="userId != null" >
        user_id = #{userId,jdbcType=BIGINT},
      </if>
      <if test="userRole != null" >
        user_role = #{userRole,jdbcType=VARCHAR},
      </if>
      <if test="userLogoUrl != null" >
        user_logo_url = #{userLogoUrl,jdbcType=VARCHAR},
      </if>
      <if test="userName != null" >
        user_name = #{userName,jdbcType=VARCHAR},
      </if>
      <if test="userTag != null" >
        user_tag = #{userTag,jdbcType=VARCHAR},
      </if>
      <if test="dynamicType != null" >
        dynamic_type = #{dynamicType,jdbcType=VARCHAR},
      </if>
      <if test="content != null" >
        content = #{content,jdbcType=VARCHAR},
      </if>
      <if test="pic1 != null" >
        pic1 = #{pic1,jdbcType=VARCHAR},
      </if>
      <if test="pic2 != null" >
        pic2 = #{pic2,jdbcType=VARCHAR},
      </if>
      <if test="pic3 != null" >
        pic3 = #{pic3,jdbcType=VARCHAR},
      </if>
      <if test="pic4 != null" >
        pic4 = #{pic4,jdbcType=VARCHAR},
      </if>
      <if test="pic5 != null" >
        pic5 = #{pic5,jdbcType=VARCHAR},
      </if>
      <if test="pic6 != null" >
        pic6 = #{pic6,jdbcType=VARCHAR},
      </if>
      <if test="pic7 != null" >
        pic7 = #{pic7,jdbcType=VARCHAR},
      </if>
      <if test="pic8 != null" >
        pic8 = #{pic8,jdbcType=VARCHAR},
      </if>
      <if test="pic9 != null" >
        pic9 = #{pic9,jdbcType=VARCHAR},
      </if>
      <if test="videoUrl != null" >
        video_url = #{videoUrl,jdbcType=VARCHAR},
      </if>
      <if test="videoPicUrl != null" >
        video_pic_url = #{videoPicUrl,jdbcType=VARCHAR},
      </if>
      <if test="visibility != null" >
        visibility = #{visibility,jdbcType=TINYINT},
      </if>
      <if test="blackList != null" >
        black_list = #{blackList,jdbcType=VARCHAR},
      </if>
      <if test="whiteList != null" >
        white_list = #{whiteList,jdbcType=VARCHAR},
      </if>
      <if test="longitude != null" >
        longitude = #{longitude,jdbcType=BIGINT},
      </if>
      <if test="latitude != null" >
        latitude = #{latitude,jdbcType=BIGINT},
      </if>
      <if test="locationName != null" >
        location_name = #{locationName,jdbcType=VARCHAR},
      </if>
      <if test="isDelete != null" >
        is_delete = #{isDelete,jdbcType=TINYINT},
      </if>
      <if test="deleteTime != null" >
        delete_time = #{deleteTime,jdbcType=TIMESTAMP},
      </if>
      <if test="createTime != null" >
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>

  
  <sql id="Base_Column_List" >
    id, uuid, school_id, user_id, user_role, user_logo_url, user_name, user_tag, dynamic_type, 
    content, pic1, pic2, pic3, pic4, pic5, pic6, pic7, pic8, pic9, video_url, video_pic_url, 
    visibility, black_list, white_list, longitude, latitude, location_name, is_delete, 
    delete_time, create_time
  </sql>
  
  
</mapper>
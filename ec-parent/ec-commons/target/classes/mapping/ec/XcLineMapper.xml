<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.imexue.ec.common.mapper.ec.XcLineMapper" >
   
  <sql id="Base_Column_List" >
    id, school_id, line_name,   teacher_id, is_delete, create_time, driver_id,
    creator_role, creator_id, update_time, updater_role, updater_id, version_no
  </sql>
  
  <sql id="page_Column_List" >
   	xl.id,xl.school_id, xl.line_name,    xl.teacher_id, xl.version_no, xb.nuclear_seating, xb.plate_number,
	(select count(1) from t_xc_child xc where xc.line_id=xl.id and xc.school_id=xl.school_id ) childCount
  </sql>
  
  <sql id="vo_Column_List" >
    xl.id, xl.school_id, xl.line_name,   xl.teacher_id, xl.is_delete, xl.create_time, 
    xl.creator_role, xl.creator_id,xl.update_time, xl.updater_role, xl.updater_id, xl.version_no 
  </sql>
  <select id="getById" resultType="cn.imexue.ec.common.model.XcLine" parameterType="java.lang.Long" >
    select 
    <include refid="Base_Column_List" />
    from t_xc_line
    where id = #{id,jdbcType=BIGINT} and is_delete=0
  </select>
  <!-- 查询当前学校可用的所有线路 -->
  <select id="findAllBySchoolId"   resultType="XcLineBusVo" >
    select   
    <include refid="vo_Column_List" /> 
    from t_xc_line   xl
 	WHERE
	xl.school_id = #{schoolId,jdbcType=BIGINT}
 	AND xl.is_delete = 0
 	AND xl.id NOT IN (
	SELECT
		xb.line_id
	FROM
		t_xc_bus xb
	WHERE
		xb.is_delete = 0
	AND xb.`status` = 0
	)
	
  </select>
  <!-- 查询线路 -->
  <select id="pageLists" resultType="XcLineVo" >
    select 
    <include refid="page_Column_List" />
    from t_xc_line xl 
    LEFT JOIN t_xc_bus xb ON (xb.line_id = xl.id and xb.is_delete=0 and xb.school_id = #{schoolId ,jdbcType=BIGINT})
    where  xl.is_delete=0  AND  xl.school_id = #{schoolId ,jdbcType=BIGINT}
     
    <if test="lineName != null">
		AND xl.line_name like concat('%',#{lineName,jdbcType=VARCHAR},'%')
	</if>
 	ORDER BY ${orderBy} ${orderType}
  </select>
  <!-- 获取校车线路列表 -->
  <select id="queryAllByParam" resultType="cn.imexue.ec.common.model.XcLine" >
    select 
    <include refid="Base_Column_List" />
    from t_xc_line xl 
   	where  xl.is_delete=0  AND  xl.school_id = #{schoolId ,jdbcType=BIGINT}
    <if test="lineName != null">
		AND xl.line_name =#{lineName,jdbcType=VARCHAR} 
	</if>
   </select>
  
  <delete id="deleteById" parameterType="java.lang.Long" >
    delete from t_xc_line
    where id = #{id,jdbcType=BIGINT}
  </delete>
  
  <insert id="insert" parameterType="cn.imexue.ec.common.model.XcLine"  useGeneratedKeys="true" keyProperty="id">
   	<selectKey resultType="java.lang.Long" order="AFTER" keyProperty="id">
          SELECT LAST_INSERT_ID()
     </selectKey>
    insert into t_xc_line
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="schoolId != null" >
        school_id,
      </if>
      <if test="lineName != null" >
        line_name,
      </if>
      
      <if test="teacherId != null" >
        teacher_id,
      </if>
      <if test="isDelete != null" >
        is_delete,
      </if>
      <if test="createTime != null" >
        create_time,
      </if>
      <if test="creatorRole != null" >
        creator_role,
      </if>
      <if test="creatorId != null" >
        creator_id,
      </if>
      <if test="updateTime != null" >
        update_time,
      </if>
      <if test="updaterRole != null" >
        updater_role,
      </if>
      <if test="updaterId != null" >
        updater_id,
      </if>
      <if test="versionNo != null" >
        version_no,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=BIGINT},
      </if>
      <if test="schoolId != null" >
        #{schoolId,jdbcType=BIGINT},
      </if>
      <if test="lineName != null" >
        #{lineName,jdbcType=VARCHAR},
      </if>
      <if test="teacherId != null" >
        #{teacherId,jdbcType=BIGINT},
      </if>
      <if test="isDelete != null" >
        #{isDelete,jdbcType=TINYINT},
      </if>
      <if test="createTime != null" >
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="creatorRole != null" >
        #{creatorRole,jdbcType=VARCHAR},
      </if>
      <if test="creatorId != null" >
        #{creatorId,jdbcType=BIGINT},
      </if>
      <if test="updateTime != null" >
        #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updaterRole != null" >
        #{updaterRole,jdbcType=VARCHAR},
      </if>
      <if test="updaterId != null" >
        #{updaterId,jdbcType=BIGINT},
      </if>
      <if test="versionNo != null" >
        #{versionNo,jdbcType=INTEGER},
      </if>
    </trim>
  </insert>
  <update id="update" parameterType="cn.imexue.ec.common.model.XcLine" >
    update t_xc_line
    <set >
      <if test="schoolId != null" >
        school_id = #{schoolId,jdbcType=BIGINT},
      </if>
      <if test="lineName != null" >
        line_name = #{lineName,jdbcType=VARCHAR},
      </if>
      <if test="teacherId != null" >
        teacher_id = #{teacherId,jdbcType=BIGINT},
      </if>
      <if test="isDelete != null" >
        is_delete = #{isDelete,jdbcType=TINYINT},
      </if>
      <if test="createTime != null" >
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="creatorRole != null" >
        creator_role = #{creatorRole,jdbcType=VARCHAR},
      </if>
      <if test="creatorId != null" >
        creator_id = #{creatorId,jdbcType=BIGINT},
      </if>
      <if test="updateTime != null" >
        update_time = #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updaterRole != null" >
        updater_role = #{updaterRole,jdbcType=VARCHAR},
      </if>
      <if test="updaterId != null" >
        updater_id = #{updaterId,jdbcType=BIGINT},
      </if>
         version_no = version_no+1
     </set>
    where id = #{id,jdbcType=BIGINT} and version_no = #{versionNo}
  </update>
 
</mapper>